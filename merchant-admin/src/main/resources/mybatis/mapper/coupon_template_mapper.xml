<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uestc.onecoupon.merchant.admin.dao.mapper.CouponTemplateMapper">

    <resultMap id="dataMap" type="com.uestc.onecoupon.merchant.admin.dao.entity.CouponTemplateDO">
        <id column="id" property="id"/>
        <result column="shop_number" property="shopNumber"/>
        <result column="name" property="name"/>
        <result column="source" property="source"/>
        <result column="target" property="target"/>
        <result column="goods" property="goods"/>
        <result column="type" property="type"/>
        <result column="valid_start_time" property="validStartTime"/>
        <result column="valid_end_time" property="validEndTime"/>
        <result column="stock" property="stock"/>
        <result column="receive_rule" property="receiveRule"/>
        <result column="consume_rule" property="consumeRule"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="del_flag" property="delFlag"/>
    </resultMap>

    <insert id="insert" parameterType="com.uestc.onecoupon.merchant.admin.dao.entity.CouponTemplateDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO coupon_template (shop_number, name, source, target, goods, type, valid_start_time, valid_end_time, stock, receive_rule, consume_rule, status)
        VALUES (#{shopNumber}, #{name}, #{source}, #{target}, #{goods}, #{type}, #{validStartTime}, #{validEndTime}, #{stock}, #{receiveRule}, #{consumeRule}, #{status})
    </insert>
    <select id="queryPage" resultMap="dataMap">
        SELECT name, source, target, goods, type, valid_start_time, valid_end_time, stock, receive_rule, consume_rule
        from coupon_template
        <where>
            <!-- 必须的条件：shopNumber -->
            shop_number = #{shopNumber}

            <!-- 动态添加条件：name -->
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>

            <!-- 动态添加条件：target -->
            <if test="target != null">
                AND target = #{target}
            </if>

            <!-- 动态添加条件：goods -->
            <if test="goods != null and goods != ''">
                AND goods LIKE CONCAT('%', #{goods}, '%')
            </if>

            <!-- 动态添加条件：type -->
            <if test="type != null">
                AND type = #{type}
            </if>


        </where>
    </select>

    <select id="query" resultMap="dataMap">
        SELECT id, name, shop_number, source, target, goods, type, valid_start_time, valid_end_time, stock, receive_rule, consume_rule, status
        from coupon_template
        where shop_number = #{shopNumber} AND id = #{id}

    </select>

    <update id="increaseNumberCouponTemplate">
        UPDATE coupon_template
        SET stock = stock + #{number}
        WHERE shop_number = #{couponTemplateDOReq.shopNumber}
          AND id = #{couponTemplateDOReq.id}
    </update>
    <update id="updateCouponTemplateEnd">
        UPDATE coupon_template
        SET status = 1
        WHERE shop_number = #{shopNumber}
          AND id = #{id}
    </update>

</mapper>
